# Multi-daemon cluster discovery with Docker Compose
#
# Build:   docker compose build    (uses Dockerfile at repo root)
# Start:   docker compose up -d
# Inspect: socketley cluster ls
#
# The shared "cluster" volume lets all daemons discover each other.
# The gateway proxy uses @api to route to all api instances.

volumes:
  cluster:

services:
  api1:
    build:
      context: ../../..
      dockerfile: Dockerfile
    command: >
      sh -c "socketley daemon &
             sleep 1 &&
             socketley daemon --name api1 --cluster /cluster &&
             socketley create server web -p 9001 -g api -s &&
             wait"
    volumes:
      - cluster:/cluster

  api2:
    build:
      context: ../../..
      dockerfile: Dockerfile
    command: >
      sh -c "socketley daemon &
             sleep 1 &&
             socketley daemon --name api2 --cluster /cluster &&
             socketley create server web -p 9001 -g api -s &&
             wait"
    volumes:
      - cluster:/cluster

  gateway:
    build:
      context: ../../..
      dockerfile: Dockerfile
    command: >
      sh -c "socketley daemon &
             sleep 1 &&
             socketley daemon --name gateway --cluster /cluster &&
             sleep 1 &&
             socketley create proxy gw -p 8080 --backend @api --protocol tcp -s &&
             wait"
    volumes:
      - cluster:/cluster
    ports:
      - "8080:8080"
