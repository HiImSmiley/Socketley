# Multi-daemon cluster discovery with Docker Compose
#
# Start: docker compose up -d
# Scale: docker compose scale api=5
# Inspect: socketley cluster --cluster-dir /tmp/cluster ls
#
# The shared "cluster" volume lets all daemons discover each other.
# The gateway proxy uses @api to route to all api instances.

version: "3.8"

volumes:
  cluster:

services:
  api1:
    image: socketley
    command: >
      sh -c "socketley daemon --name api1 --cluster /cluster &
             sleep 1 &&
             socketley create server web -p 9001 -g api -s &&
             wait"
    volumes:
      - cluster:/cluster

  api2:
    image: socketley
    command: >
      sh -c "socketley daemon --name api2 --cluster /cluster &
             sleep 1 &&
             socketley create server web -p 9001 -g api -s &&
             wait"
    volumes:
      - cluster:/cluster

  gateway:
    image: socketley
    command: >
      sh -c "socketley daemon --name gateway --cluster /cluster &
             sleep 2 &&
             socketley create proxy gw -p 8080 --backend @api --protocol tcp -s &&
             wait"
    volumes:
      - cluster:/cluster
    ports:
      - "8080:8080"
